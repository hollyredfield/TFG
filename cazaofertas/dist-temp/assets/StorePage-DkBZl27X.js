import{j as e}from"./ui-BJ93jQot.js";import{i as I,a as s,L as B}from"./vendor-TA_wDYrC.js";import{U,a3 as $,aF as z,O as A}from"./index-BlDEwxQf.js";import{O as q}from"./OfferCard-COSGjkOA.js";import{t as V,o as G}from"./mockData-0ElwO_P3.js";import{g as H}from"./ImageWithFallback-BgI07kEf.js";import"react-toastify";import"./StarRating-DMe66NK6.js";const J=()=>new Promise(l=>setTimeout(l,500)),K=async l=>{await J();const d=V.find(t=>t.slug===l.toLowerCase());if(!d)throw new Error("Tienda no encontrada");const u=G.filter(t=>t.store_id===d.id);return{...d,lastUpdate:new Date().toISOString(),stats:{offerCount:u.length,totalSaved:u.reduce((t,n)=>t+(n.original_price-n.current_price),0),averageDiscount:Math.round(u.reduce((t,n)=>t+(n.original_price-n.current_price)/n.original_price*100,0)/(u.length||1))}}},se=()=>{var _;const{storeName:l}=I(),[d,u]=s.useState([]),[t,n]=s.useState([]),[P,f]=s.useState(!0),[w,M]=s.useState(!1),[m,v]=s.useState(""),[c,T]=s.useState(null),[N,b]=s.useState(null),[g,y]=s.useState([0,5e3]),[h,k]=s.useState(0),[j,S]=s.useState("newest");s.useEffect(()=>{const r=new AbortController,a=setTimeout(()=>{r.abort(),console.error("[StorePage] ⏰ Timeout después de 10s"),f(!1),b("Tiempo de espera agotado. Por favor, intenta de nuevo.")},1e4);return(async()=>{const E=performance.now();console.log("[StorePage] 🟡 Iniciando fetch de tienda:",decodeURIComponent(l));try{f(!0),b(null);const x=decodeURIComponent(l);console.log("[StorePage] ⬇️ Solicitando datos...");const[C,F]=await Promise.all([Promise.race([K(x),new Promise((Q,O)=>setTimeout(()=>O(new Error("Timeout")),5e3))]),A.from("ofertas").select(`
              *,
              categorias:id_categoria (
                nombre,
                slug,
                icono,
                color
              ),
              perfiles_usuario:id_usuario (
                nombre_usuario,
                url_avatar,
                esta_verificado
              )
            `).eq("tienda",x).eq("ha_expirado",!1)]),{data:p,error:D}=F;if(D)throw D;if(!p)throw new Error("No se recibieron datos de ofertas");console.log("[StorePage] ✅ Datos recibidos:","Ofertas:",p.length,"Info tienda:",C?"Sí":"No");const L=performance.now();console.log("[StorePage] ⏱️ Tiempo total:",Math.round(L-E),"ms"),T(C||{name:x,logo:null,description:`Ofertas de ${x}`}),u(p),n(p)}catch(x){console.error("[StorePage] 🔴 Error:",x),b(x.message)}finally{f(!1),clearTimeout(a)}})(),()=>{r.abort(),clearTimeout(a)}},[l]),s.useEffect(()=>{if(!d.length)return;let r=[...d];switch(m&&(r=r.filter(a=>a.titulo.toLowerCase().includes(m.toLowerCase())||a.descripcion.toLowerCase().includes(m.toLowerCase()))),r=r.filter(a=>a.precio_actual>=g[0]&&a.precio_actual<=g[1]),h>0&&(r=r.filter(a=>(a.porcentaje_descuento||0)>=h)),j){case"price-asc":r.sort((a,i)=>a.precio_actual-i.precio_actual);break;case"price-desc":r.sort((a,i)=>i.precio_actual-a.precio_actual);break;case"discount":r.sort((a,i)=>(i.porcentaje_descuento||0)-(a.porcentaje_descuento||0));break;case"oldest":r.sort((a,i)=>new Date(a.creado_en)-new Date(i.creado_en));break;default:r.sort((a,i)=>new Date(i.creado_en)-new Date(a.creado_en))}n(r)},[d,m,g,h,j]);const R=()=>{y([0,5e3]),k(0),S("newest"),v("")},o=decodeURIComponent(l);return e.jsx("div",{className:"container mx-auto px-4 py-8 pt-20",children:P?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"w-16 h-16 flex items-center justify-center rounded-full bg-indigo-500 overflow-hidden",children:["                  ",c!=null&&c.logo?e.jsx("img",{src:H(c.logo,`${o} logo`,null,o),alt:`${o} logo`,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-indigo-500 text-white text-2xl font-bold",children:((_=o==null?void 0:o.charAt(0))==null?void 0:_.toUpperCase())||"?"})]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:o}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:(c==null?void 0:c.description)||`Explora las mejores ofertas disponibles en ${o}`}),e.jsxs("div",{className:"flex items-center mt-2 space-x-4",children:[e.jsxs("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:[t.length," ofertas disponibles"]}),e.jsxs("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Actualizado: ",new Date().toLocaleDateString()]})]})]})]}),e.jsx("div",{className:"flex space-x-2",children:e.jsxs("button",{onClick:()=>M(!w),className:"bg-indigo-100 text-indigo-700 dark:bg-indigo-700 dark:text-indigo-100 px-4 py-2 rounded-lg flex items-center",children:[e.jsx(U,{className:"mr-2"}),"Filtros"]})})]}),e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsx("div",{className:"flex-grow",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:`Buscar ofertas en ${o}`,className:"w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 focus:outline-none dark:bg-gray-700 dark:text-white",value:m,onChange:r=>v(r.target.value)}),e.jsx("button",{className:"absolute right-2 top-2 text-gray-400 dark:text-gray-300",children:e.jsx($,{className:"h-6 w-6"})})]})}),e.jsxs("select",{className:"px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 focus:outline-none dark:bg-gray-700 dark:text-white",onChange:r=>S(r.target.value),value:j,children:[e.jsx("option",{value:"newest",children:"Más recientes"}),e.jsx("option",{value:"price-low",children:"Precio: Menor a Mayor"}),e.jsx("option",{value:"price-high",children:"Precio: Mayor a Menor"}),e.jsx("option",{value:"discount",children:"Mayor descuento"}),e.jsx("option",{value:"popularity",children:"Más populares"})]})]}),w&&e.jsxs("div",{className:"mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-3",children:"Filtros avanzados"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Rango de precio"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"number",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-800 dark:text-white",placeholder:"Min",value:g[0],onChange:r=>y([parseInt(r.target.value)||0,g[1]])}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"-"}),e.jsx("input",{type:"number",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-800 dark:text-white",placeholder:"Max",value:g[1],onChange:r=>y([g[0],parseInt(r.target.value)||5e3])})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Descuento mínimo"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"range",min:"0",max:"100",step:"5",value:h,onChange:r=>k(parseInt(r.target.value)),className:"w-full"}),e.jsxs("span",{className:"ml-2 text-gray-700 dark:text-gray-300 w-10 text-center",children:[h,"%"]})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{onClick:R,className:"px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500",children:"Restablecer filtros"})})]})]})]})]}),t.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:t.map(r=>e.jsx(q,{offer:r},r.id))}):e.jsxs("div",{className:"text-center py-16 bg-white dark:bg-gray-800 rounded-lg shadow",children:[e.jsx(z,{className:"w-16 h-16 mx-auto text-gray-300 dark:text-gray-600"}),e.jsx("h3",{className:"mt-4 text-2xl font-medium text-gray-900 dark:text-gray-100",children:"No hay ofertas disponibles"}),e.jsxs("p",{className:"mt-2 text-gray-500 dark:text-gray-400 max-w-md mx-auto",children:["No se encontraron ofertas de ",o," con los filtros seleccionados. Intenta cambiar los filtros o busca más tarde.",N&&e.jsxs("span",{className:"block mt-2 text-red-500",children:["Error: ",N]})]}),e.jsx("div",{className:"mt-6",children:e.jsx(B,{to:"/",className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",children:"Volver al inicio"})})]}),t.length>20&&e.jsx("div",{className:"mt-8 flex justify-center",children:e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("button",{className:"px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z",clipRule:"evenodd"})})}),e.jsx("button",{className:"px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-indigo-600 text-white font-medium",children:"1"}),e.jsx("button",{className:"px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700",children:"2"}),e.jsx("button",{className:"px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z",clipRule:"evenodd"})})})]})})]})})};export{se as default};
