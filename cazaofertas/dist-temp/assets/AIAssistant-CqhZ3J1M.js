import{j as e}from"./ui-BJ93jQot.js";import{a as l,R as X,L as J}from"./vendor-TA_wDYrC.js";import{u as O,K as E,c as W,L as Y,M as Z,w as T,N as ee,O as F,P as se,Q as ae,R as re,n as te,S as oe,T as ne,s as ie}from"./index-BlDEwxQf.js";import{g as le}from"./openrouter-DmZqj64n.js";import"react-toastify";const de={"mejores ofertas de tecnología":"Actualmente, tenemos grandes ofertas en portátiles, smartphones y auriculares inalámbricos. Te recomiendo visitar la categoría de Tecnología donde encontrarás descuentos de hasta el 40% en marcas como Samsung, Apple y Xiaomi. Las ofertas más populares esta semana son en tarjetas gráficas y monitores gaming.","recibir notificaciones":'Para recibir notificaciones de ofertas, debes iniciar sesión en tu cuenta y luego ir a "Mi Perfil > Preferencias > Notificaciones". Allí puedes activar las alertas para categorías específicas, establecer un rango de precios y decidir si quieres recibir notificaciones por email, navegador o ambas.',"plan compras":`Para crear tu plan de compras, por favor indícame:
- Presupuesto disponible
- Número de personas
- Categorías de interés
- Marcas preferidas si las hay`,"crear plan":`Puedo ayudarte a crear un plan de compras. Necesito saber:
- Tu presupuesto
- Cantidad de personas
- Tipos de productos que buscas
- Preferencias específicas`,"subir una oferta":'Para subir una oferta a la plataforma, debes estar registrado y hacer clic en el botón "Publicar Oferta" que aparece en la parte superior de la página. Luego completa el formulario con los detalles del producto, precio original, precio en oferta, enlace a la tienda y una imagen. Tu oferta será revisada brevemente antes de publicarse.',hola:"¡Hola! Soy el asistente virtual de CazaOfertas. Estoy aquí para ayudarte a encontrar las mejores ofertas y resolver cualquier duda sobre la plataforma. ¿En qué puedo asistirte hoy?"},L=i=>{const x=i.toLowerCase();for(const[d,p]of Object.entries(de))if(x.includes(d))return p;return"Lo siento, no puedo proporcionar información específica sobre eso en este momento. Te sugiero buscar ofertas usando los filtros de categorías o la función de búsqueda en la parte superior del sitio."},ce=()=>{const{user:i}=O(),[x,d]=l.useState([{role:"assistant",content:"👋 ¡Hola! Soy tu asistente de CazaOfertas. Puedo ayudarte a encontrar las mejores ofertas, resolver dudas sobre la plataforma o darte consejos de ahorro. ¿En qué puedo ayudarte hoy?"}]),[p,b]=l.useState(""),[v,f]=l.useState(!1),[M,R]=l.useState(0),[y,k]=l.useState(!0),[N,S]=l.useState(!1),[c,$]=l.useState({budget:null,people:null,categories:[],preferences:[]}),[I,m]=l.useState(["¿Cuáles son las mejores ofertas de tecnología?","¿Cómo puedo recibir notificaciones de ofertas?","¿Puedes crear un plan de compras personalizado?","¿Cómo subir una oferta a la plataforma?"]),q=l.useRef(null),[D,g]=l.useState([]),K=async()=>{const{data:{user:s}}=await F.auth.getUser();if(!s){const o={message:"Usuario no autenticado. Por favor, inicia sesión."};return{profileResult:{error:o},ordersResult:{error:o},ticketsResult:{error:o}}}let t;try{const{data:o,error:w,status:P}=await F.from("perfiles_usuario").select("nombre_usuario, biografia, url_avatar").eq("id",s.id).single();w&&P!==406?(console.error("Error fetching profile:",w),t={error:{message:"Error al cargar la información del perfil."}}):o?t={data:o}:t={status:"nodata",message:"No se encontró un perfil de usuario asociado a esta cuenta. Puedes crear uno en tu página de perfil."}}catch(o){console.error("Exception fetching profile:",o),t={error:{message:"Ocurrió un problema al intentar obtener la información del perfil."}}}return{profileResult:t,ordersResult:{status:"unavailable",message:"La información de pedidos no está disponible en este momento."},ticketsResult:{status:"unavailable",message:"La información de tickets de soporte no está disponible en este momento."}}};l.useEffect(()=>{var s;(s=q.current)==null||s.scrollIntoView({behavior:"smooth"})},[x]);const U=s=>["plan","compras","presupuesto","lista","shopping"].some(u=>s.toLowerCase().includes(u)),Q=s=>{const t=s.match(/\d+\s*(?:€|euros)/i),u=s.match(/\d+\s*(?:personas?|gente|family|familia)/i),h=s.match(/(?:tecnología|ropa|hogar|alimentos|electrónica|deportes)/gi);if(t||u||h){const o={...c};return t&&(o.budget=parseInt(t[0])),u&&(o.people=parseInt(u[0])),h&&(o.categories=[...new Set([...o.categories,...h])]),$(o),!0}return!1},H=s=>{b(s.target.value)},B=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),z())},G=s=>{b(s)},V=()=>{k(s=>!s),d(s=>[...s,{role:"system",content:`Modo ${y?"local":"API"} activado.`}])},z=async()=>{if(p.trim()===""||v)return;const s={role:"user",content:p};d(o=>[...o,s]);const t=[...D,s];g(t);const u=p,h=p.toLowerCase();b(""),f(!0);try{if(["mi perfil","mis datos","mis pedidos","mis tickets","mi historial","mi información","mi cuenta"].some(a=>h.includes(a))){if(!i){const n={role:"assistant",content:"Para acceder a tu información personal, por favor inicia sesión primero. Puedes hacerlo desde el menú de navegación."};d(C=>[...C,n]),g(C=>[...C,n]),f(!1);return}d(n=>[...n,{role:"assistant",content:"Consultando tu información..."}]);const a=await K();let r="Aquí tienes un resumen de tu información:\\n\\n";if(a&&a.profileResult){if(a.profileResult.data){const n=a.profileResult.data;r+="**Perfil:**\\n",r+=`  - Email: ${i.email}\\n`,n.nombre_usuario?r+=`  - Nombre de usuario: ${n.nombre_usuario}\\n`:r+="  - Nombre de usuario: Aún no lo has configurado. Puedes añadirlo en tu perfil.\\n",n.biografia&&n.biografia.trim()!==""?r+=`  - Biografía: ${n.biografia}\\n`:r+="  - Biografía: Aún no has añadido una. ¡Anímate a compartir algo sobre ti en tu perfil!\\n",n.url_avatar&&n.url_avatar.trim()!==""?r+="  - Avatar: Has configurado una imagen de perfil.\\n":r+="  - Avatar: Aún no tienes una imagen de perfil. ¡Sube una para personalizar tu cuenta!\\n",r+="\\n"}else a.profileResult.status==="nodata"?r+=`**Perfil:**\\n  - Email: ${i.email}\\n  - ${a.profileResult.message}\\n\\n`:a.profileResult.error?r+=`**Perfil:**\\n  - Email: ${i.email}\\n  - ${a.profileResult.error.message}\\n\\n`:r+=`**Perfil:**\\n  - Email: ${i.email}\\n  - No se pudo obtener la información del perfil en este momento.\\n\\n`;a.ordersResult&&a.ordersResult.status==="unavailable"?r+=`**Pedidos:**\\n  - ${a.ordersResult.message}\\n\\n`:a.ordersResult&&a.ordersResult.error?r+=`**Pedidos:**\\n  - ${a.ordersResult.error.message}\\n\\n`:r+="**Pedidos:**\\n  - No se pudo obtener la información de pedidos.\\n\\n",a.ticketsResult&&a.ticketsResult.status==="unavailable"?r+=`**Tickets de Soporte:**\\n  - ${a.ticketsResult.message}\\n\\n`:a.ticketsResult&&a.ticketsResult.error?r+=`**Tickets de Soporte:**\\n  - ${a.ticketsResult.error.message}\\n\\n`:r+="**Tickets de Soporte:**\\n  - No se pudo obtener la información de tickets de soporte.\\n\\n",r+="Puedes pedirme más detalles sobre un pedido o ticket específico (funcionalidad futura), o visitar las secciones correspondientes en tu perfil."}else r="Lo siento, hubo un problema al intentar recuperar tu información personal. Por favor, inténtalo más tarde.";d(n=>n.filter(C=>C.content!=="Consultando tu información..."));const A={role:"assistant",content:r};d(n=>[...n,A]),g(n=>[...n,A]),f(!1);return}if(U(u)&&(S(!0),Q(u))){const r={role:"assistant",content:`He detectado los siguientes detalles para tu plan de compras:
${c.budget?`💰 Presupuesto: ${c.budget}€
`:""}${c.people?`👥 Personas: ${c.people}
`:""}${c.categories.length>0?`🏷️ Categorías: ${c.categories.join(", ")}
`:""}
¿Quieres que te ayude a crear un plan de compras con estos detalles?`};d(A=>[...A,r]),g(A=>[...A,r]),f(!1);return}let j;if(y)try{j=await le(t),j.includes("Lo siento, ha ocurrido un error")||j.includes("hay un problema con la autenticación")?(R(a=>a+1),M>=2&&(k(!1),console.log("Demasiados errores de API, cambiando a respuestas locales")),j=L(u)):R(0)}catch(a){console.error("Error con OpenRouter:",a),R(r=>r+1),M>=2&&(k(!1),console.log("Demasiados errores de API, cambiando a respuestas locales")),j=L(u)}else j=L(u);const _={role:"assistant",content:j};d(a=>[...a,_]),g(a=>[...a,_])}catch(o){console.error("Error general en el chat:",o);const w={role:"assistant",content:"Lo siento, ha ocurrido un error al procesar tu mensaje. Por favor, inténtalo de nuevo."};d(P=>[...P,w]),g(P=>[...P,w])}finally{f(!1)}};return e.jsxs("div",{className:"flex flex-col h-[700px] rounded-xl overflow-hidden shadow-2xl bg-gradient-to-br from-gray-900 to-gray-800 border border-indigo-500/30",children:[e.jsxs("div",{className:"bg-gradient-to-r from-indigo-900 to-purple-900 p-4 flex items-center justify-between text-white",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center mr-3",children:e.jsx(E,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-lg",children:"Asistente IA CazaOfertas"}),e.jsx("p",{className:"text-xs text-indigo-200",children:i?`Personalizado para ${i.email}`:"Siempre disponible para ayudarte"})]})]}),e.jsxs("div",{className:"flex items-center",children:[!y&&e.jsxs("div",{className:"bg-yellow-600 text-white text-xs px-2 py-1 rounded-md mr-2 flex items-center",children:[e.jsx(W,{className:"mr-1"})," Modo local"]}),e.jsxs("button",{onClick:V,className:"text-xs bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded-md mr-2 transition-colors border border-gray-600",title:"Cambiar entre modo API y modo local",children:["Modo ",y?"API":"Local"]}),e.jsx("div",{className:`h-2 w-2 rounded-full ${y?"bg-green-400":"bg-yellow-400"} animate-pulse`})]})]}),N&&e.jsxs("div",{className:"bg-indigo-900/30 border-b border-indigo-500/30 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h4",{className:"text-indigo-200 font-medium flex items-center",children:[e.jsx(Y,{className:"mr-2"})," Plan de Compras Activo"]}),e.jsx("button",{onClick:()=>S(!1),className:"text-indigo-300 hover:text-indigo-100",children:e.jsx(Z,{})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"bg-indigo-800/30 rounded p-2",children:[e.jsx("span",{className:"text-indigo-300",children:"Presupuesto:"}),e.jsx("span",{className:"float-right text-white",children:c.budget?`${c.budget}€`:"No definido"})]}),e.jsxs("div",{className:"bg-indigo-800/30 rounded p-2",children:[e.jsx("span",{className:"text-indigo-300",children:"Personas:"}),e.jsx("span",{className:"float-right text-white",children:c.people||"No definido"})]})]}),c.categories.length>0&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:c.categories.map((s,t)=>e.jsx("span",{className:"bg-indigo-700/50 text-indigo-200 px-2 py-1 rounded text-xs",children:s},t))})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 bg-gray-800/70 backdrop-blur-sm space-y-4",children:[x.map((s,t)=>e.jsxs("div",{className:`flex ${s.role==="user"?"justify-end":s.role==="system"?"justify-center":"justify-start"}`,children:[s.role==="assistant"&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center mr-2 flex-shrink-0",children:e.jsx(E,{className:"h-4 w-4 text-white"})}),e.jsxs("div",{className:`rounded-2xl p-4 max-w-[75%] shadow-md ${s.role==="user"?"bg-gradient-to-r from-indigo-600 to-indigo-700 text-white rounded-tr-none":s.role==="system"?"bg-yellow-600/20 text-yellow-200 text-sm px-3 py-1":"bg-gradient-to-r from-gray-700 to-gray-800 text-gray-100 rounded-tl-none border border-indigo-500/20"}`,children:[s.content.split(`
`).map((u,h)=>e.jsxs(X.Fragment,{children:[u,h<s.content.split(`
`).length-1&&e.jsx("br",{})]},h)),s.role!=="system"&&e.jsx("div",{className:`text-xs mt-1 ${s.role==="user"?"text-indigo-200":"text-gray-400"}`,children:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),s.role==="user"&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center ml-2 flex-shrink-0",children:e.jsx(T,{className:"h-4 w-4 text-white"})})]},t)),v&&e.jsxs("div",{className:"flex justify-start mb-4",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center mr-2 flex-shrink-0",children:e.jsx(E,{className:"h-4 w-4 text-white"})}),e.jsx("div",{className:"bg-gradient-to-r from-gray-700 to-gray-800 text-white rounded-2xl p-4 max-w-[75%] rounded-tl-none shadow-md border border-indigo-500/20",children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("div",{className:"h-2 w-2 bg-indigo-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"h-2 w-2 bg-indigo-400 rounded-full animate-bounce",style:{animationDelay:"100ms"}}),e.jsx("div",{className:"h-2 w-2 bg-indigo-400 rounded-full animate-bounce",style:{animationDelay:"200ms"}})]})})]}),e.jsx("div",{ref:q})]}),e.jsx("div",{className:"flex flex-wrap gap-2 px-4 py-3 bg-gray-900",children:I.map((s,t)=>e.jsx("button",{onClick:()=>G(s),className:"text-xs bg-indigo-900/50 text-indigo-100 px-3 py-1.5 rounded-full hover:bg-indigo-800 transition-colors border border-indigo-700/50",children:s},t))}),e.jsxs("div",{className:"p-4 bg-gray-900 border-t border-gray-800",children:[e.jsxs("div",{className:"relative flex items-center",children:[e.jsx("textarea",{value:p,onChange:H,onKeyDown:B,placeholder:N?"Cuéntame más detalles sobre tu plan de compras...":"Escribe tu mensaje aquí...",className:"w-full resize-none rounded-xl bg-gray-800 text-gray-100 border border-gray-700 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 p-4 pr-12 h-[60px] placeholder-gray-500",rows:"1"}),e.jsx("button",{onClick:z,disabled:v||p.trim()==="",className:`absolute right-3 p-2 rounded-full ${v||p.trim()===""?"bg-gray-700 text-gray-500":"bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:from-indigo-500 hover:to-purple-500"} transition-all`,children:e.jsx(ee,{className:"h-5 w-5"})})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 text-center",children:N?"Estoy aquí para ayudarte a crear un plan de compras personalizado 🛍️":"Las respuestas son generadas por IA y pueden no ser siempre precisas."})]})]})},xe=()=>{var N,S,c,$,I;const{user:i,initialized:x}=O(),[d,p]=l.useState(!1),[b,v]=l.useState(null),[f,M]=l.useState("assistant"),R=l.useMemo(()=>performance.now(),[]);l.useEffect(()=>{let m=!0;x&&!d&&((async()=>{if(i)try{const{data:g}=await F.from("perfiles").select(`
            *,
            pedidos (count),
            ofertas_guardadas (count),
            tickets (count)
          `).eq("user_id",i.id).single();m&&v(g)}catch(g){console.error("Error loading user profile:",g)}})(),p(!0));const D=setTimeout(()=>{m&&!x&&(console.warn("[AIAssistant] ⚠️ Timeout de inicialización - Forzando carga"),p(!0))},3e3);return()=>{m=!1,clearTimeout(D)}},[x,d,R,i]);const y=[{id:"assistant",icon:E,label:"Asistente IA"},{id:"orders",icon:se,label:"Mis Pedidos",requiresAuth:!0},{id:"tickets",icon:ae,label:"Soporte",requiresAuth:!0},{id:"saved",icon:re,label:"Guardados",requiresAuth:!0},{id:"account",icon:T,label:"Mi Cuenta",requiresAuth:!0},{id:"privacy",icon:te,label:"Privacidad"},{id:"help",icon:oe,label:"Ayuda"},{id:"history",icon:ne,label:"Historial",requiresAuth:!0}],k=!x&&!d;return e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-gray-900 via-gray-800 to-black pt-20 pb-12",children:e.jsx("div",{className:"container mx-auto px-4",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-8",children:[e.jsx("div",{className:"lg:w-64 flex-shrink-0",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 shadow-xl border border-gray-700",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("h2",{className:"text-xl font-bold text-white mb-2 flex items-center",children:[e.jsx(E,{className:"text-indigo-400 mr-2"}),"Asistente IA"]}),e.jsx("p",{className:"text-sm text-gray-400",children:"Tu asistente personal para CazaOfertas"})]}),e.jsx("nav",{className:"space-y-2",children:y.map(m=>(!m.requiresAuth||i)&&e.jsxs("button",{onClick:()=>M(m.id),className:`w-full flex items-center px-4 py-2 rounded-lg text-sm transition-colors ${f===m.id?"bg-indigo-600 text-white":"text-gray-300 hover:bg-gray-700"}`,children:[e.jsx(m.icon,{className:"mr-3"}),m.label]},m.id))}),b&&e.jsx("div",{className:"mt-6 pt-6 border-t border-gray-700",children:e.jsxs("div",{className:"text-xs text-gray-500",children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{children:"Miembro desde"}),e.jsx("span",{children:new Date(b.created_at).toLocaleDateString()})]}),e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{children:"Pedidos"}),e.jsx("span",{children:((S=(N=b.pedidos)==null?void 0:N[0])==null?void 0:S.count)||0})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Ofertas guardadas"}),e.jsx("span",{children:(($=(c=b.ofertas_guardadas)==null?void 0:c[0])==null?void 0:$.count)||0})]})]})})]})}),e.jsx("div",{className:"flex-1",children:k?e.jsx("div",{className:"flex justify-center my-12",children:e.jsx(ie,{className:"text-4xl text-indigo-500 animate-spin"})}):e.jsxs("div",{className:"bg-gray-800 rounded-xl shadow-xl border border-gray-700 p-6",children:[f==="assistant"&&e.jsx(ce,{}),f==="account"&&i&&e.jsx("div",{children:e.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"Mi Cuenta"})}),!i&&((I=y.find(m=>m.id===f))==null?void 0:I.requiresAuth)&&e.jsx("div",{className:"text-center py-12",children:e.jsxs("div",{className:"bg-gray-700/50 rounded-lg p-8 max-w-md mx-auto",children:[e.jsx(T,{className:"mx-auto text-4xl text-gray-400 mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-2",children:"Inicia sesión para continuar"}),e.jsx("p",{className:"text-gray-400 mb-6",children:"Necesitas iniciar sesión para acceder a esta función"}),e.jsx(J,{to:"/login",className:"inline-block bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors",children:"Iniciar sesión"})]})})]})})]})})})};export{xe as default};
