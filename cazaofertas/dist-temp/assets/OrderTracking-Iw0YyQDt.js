import{j as e}from"./ui-BJ93jQot.js";import{i as P,a as l,L as x}from"./vendor-TA_wDYrC.js";import{u as I,o as T,l as L,aM as _,a7 as R,aN as E,aO as z,P as S,V as m,O as p,Y as A,M as V,x as B}from"./index-BlDEwxQf.js";import{a as q}from"./mockOrders-D2kgro_0.js";import{N as M}from"./notificationService-BzK7A9Fv.js";import"react-toastify";const W=()=>{var b;const{orderId:o}=P(),{user:i}=I(),[t,F]=l.useState(null),[D,g]=l.useState(!0),[f,h]=l.useState(null),[c,u]=l.useState(!0);l.useEffect(()=>{async function r(){if(!o||!i){g(!1);return}try{g(!0),h(null);const{data:a,error:s,success:n}=await q(o,i.id);if(!n||s)throw new Error((s==null?void 0:s.message)||"No se pudo cargar la información del pedido");F(a)}catch(a){console.error("Error cargando detalle de pedido:",a),h("No se pudo cargar la información del pedido. Por favor, inténtalo de nuevo."),m.error("Error al cargar el pedido")}finally{g(!1)}}r()},[o,i]),l.useEffect(()=>{(async()=>{if(!(!i||!t))try{const{data:a,error:s}=await p.from("notificaciones_preferencias").select("order_notifications").eq("user_id",i.id).single();if(s){console.error("Error loading notification preferences:",s);return}a&&a.order_notifications&&u(a.order_notifications[o]!==!1)}catch(a){console.error("Error loading notification preferences:",a)}})()},[i,t,o]);const C=async()=>{if(!(!i||!t))try{const r=!c;u(r);const{data:a}=await p.from("notificaciones_preferencias").select("order_notifications").eq("user_id",i.id).single(),s=(a==null?void 0:a.order_notifications)||{};s[o]=r;const{error:n}=await p.from("notificaciones_preferencias").upsert({user_id:i.id,order_notifications:s,updated_at:new Date().toISOString()});if(n)throw n;r?(await M.createNotification({userId:i.id,type:"NOTIFICATION_PREFERENCE_CHANGED",title:"Notificaciones de pedido activadas",message:`Recibirás actualizaciones sobre el estado de tu pedido ${t.codigo_seguimiento||o}.`,data:{order_id:o,preference_type:"order_notifications",enabled:!0}}),m.success("Notificaciones de pedido activadas")):m.success("Notificaciones de pedido desactivadas")}catch(r){console.error("Error toggling order notifications:",r),m.error("No se pudo actualizar las preferencias de notificaciones"),u(!c)}};if(D)return e.jsx("div",{className:"max-w-6xl mx-auto px-4 py-16 flex justify-center",children:e.jsx("div",{className:"animate-spin h-12 w-12 border-4 border-primary rounded-full border-t-transparent"})});if(f||!t)return e.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"bg-red-100 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg mb-6 flex items-start",children:[e.jsx(T,{className:"mt-1 mr-2 flex-shrink-0"}),e.jsx("p",{children:f||"No se encontró el pedido solicitado"})]}),e.jsx(x,{to:"/mis-pedidos",className:"button-modern button-secondary",children:"Volver a mis pedidos"})]});const O=r=>{switch(r){case"pendiente":return{icon:e.jsx(_,{}),color:"text-blue-500"};case"procesando":return{icon:e.jsx(S,{}),color:"text-yellow-500"};case"enviado":return{icon:e.jsx(E,{}),color:"text-purple-500"};case"entregado":return{icon:e.jsx(B,{}),color:"text-green-500"};case"cancelado":return{icon:e.jsx(V,{}),color:"text-red-500"};default:return{icon:e.jsx(A,{}),color:"text-gray-500"}}},{icon:y,color:$}=O(t.estado),d=(()=>{const r=["pendiente","procesando","enviado","entregado"];return t.estado==="cancelado"?-1:r.indexOf(t.estado)})();return e.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"Seguimiento de Pedido"}),e.jsx("span",{className:`text-2xl ${$}`,children:y})]}),e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 mt-2",children:["Código de pedido: ",e.jsx("span",{className:"font-medium",children:t.codigo_seguimiento})]})]}),e.jsx("div",{className:"mt-4 lg:mt-0",children:e.jsx(x,{to:"/mis-pedidos",className:"button-modern button-secondary",children:"Volver a mis pedidos"})})]}),"      ",e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-soft p-6 mb-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Estado del pedido"}),e.jsxs("button",{onClick:C,className:`flex items-center space-x-2 px-3 py-1.5 rounded-full text-sm ${c?"bg-primary/10 text-primary dark:bg-primary/20 dark:text-primary-light":"bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-gray-400"}`,title:c?"Desactivar notificaciones":"Activar notificaciones",children:[e.jsx(L,{className:c?"text-primary":"text-gray-400"}),e.jsx("span",{children:c?"Notificaciones activadas":"Notificaciones desactivadas"})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute top-5 left-0 right-0 h-1 bg-gray-200 dark:bg-gray-700 z-0"}),e.jsx("div",{className:`absolute top-5 left-0 h-1 bg-primary z-10 transition-all duration-500 ${d===-1?"w-0":d===0?"w-[12.5%]":d===1?"w-[37.5%]":d===2?"w-[62.5%]":"w-full"}`}),e.jsxs("div",{className:"grid grid-cols-4 relative z-20",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${d>=0?"bg-primary text-white":d===-1?"bg-red-500 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400"}`,children:e.jsx(_,{className:"text-lg"})}),e.jsx("p",{className:"mt-2 text-sm font-medium text-center text-gray-700 dark:text-gray-300",children:"Recibido"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 text-center mt-1",children:t.created_at&&new Date(t.created_at).toLocaleDateString()})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${d>=1?"bg-primary text-white":d===-1?"bg-red-500 text-white opacity-30":"bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400"}`,children:e.jsx(R,{className:"text-lg"})}),e.jsx("p",{className:"mt-2 text-sm font-medium text-center text-gray-700 dark:text-gray-300",children:"Procesando"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 text-center mt-1",children:t.estado==="procesando"&&t.updated_at?new Date(t.updated_at).toLocaleDateString():""})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${d>=2?"bg-primary text-white":d===-1?"bg-red-500 text-white opacity-30":"bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400"}`,children:e.jsx(E,{className:"text-lg"})}),e.jsx("p",{className:"mt-2 text-sm font-medium text-center text-gray-700 dark:text-gray-300",children:"Enviado"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 text-center mt-1",children:t.estado==="enviado"&&t.updated_at?new Date(t.updated_at).toLocaleDateString():""})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${d>=3?"bg-primary text-white":d===-1?"bg-red-500 text-white opacity-30":"bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400"}`,children:e.jsx(z,{className:"text-lg"})}),e.jsx("p",{className:"mt-2 text-sm font-medium text-center text-gray-700 dark:text-gray-300",children:"Entregado"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 text-center mt-1",children:t.estado==="entregado"&&t.updated_at?new Date(t.updated_at).toLocaleDateString():""})]})]})]}),e.jsx("div",{className:`mt-8 p-4 rounded-lg border ${t.estado==="cancelado"?"bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800":t.estado==="entregado"?"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800":"bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800"}`,children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`mr-4 text-xl ${t.estado==="cancelado"?"text-red-500 dark:text-red-400":t.estado==="entregado"?"text-green-500 dark:text-green-400":"text-blue-500 dark:text-blue-400"}`,children:y}),e.jsxs("div",{children:[e.jsxs("h3",{className:`font-medium ${t.estado==="cancelado"?"text-red-700 dark:text-red-300":t.estado==="entregado"?"text-green-700 dark:text-green-300":"text-blue-700 dark:text-blue-300"}`,children:["Estado actual: ",t.estado.charAt(0).toUpperCase()+t.estado.slice(1)]}),e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-300 mt-1",children:[t.estado==="pendiente"&&"Tu pedido ha sido recibido y está pendiente de procesamiento.",t.estado==="procesando"&&"Tu pedido está siendo preparado para envío.",t.estado==="enviado"&&"Tu pedido está en camino a la dirección de entrega.",t.estado==="entregado"&&"¡Tu pedido ha sido entregado con éxito!",t.estado==="cancelado"&&"Este pedido ha sido cancelado."]})]})]})}),e.jsxs("div",{className:"mt-8",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-3",children:"Detalles de envío"}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-1",children:"Dirección de entrega"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:t.direccion_envio})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-1",children:"Método de pago"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:t.metodo_pago})]})]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-soft overflow-hidden mb-8",children:[e.jsx("h2",{className:"p-6 border-b border-gray-200 dark:border-gray-700 text-xl font-semibold text-gray-900 dark:text-white",children:"Productos del pedido"}),e.jsx("div",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:(b=t.pedidos_items)==null?void 0:b.map(r=>{var a,s,n,j,N,k,v,w;return e.jsxs("div",{className:"p-6 flex items-center",children:[e.jsx("div",{className:"h-20 w-20 flex-shrink-0 overflow-hidden rounded-md border border-gray-200 dark:border-gray-700",children:(a=r.productos)!=null&&a.imagen_url||(s=r.ofertas)!=null&&s.imagen_url?e.jsx("img",{src:((n=r.productos)==null?void 0:n.imagen_url)||((j=r.ofertas)==null?void 0:j.imagen_url),alt:((N=r.productos)==null?void 0:N.nombre)||((k=r.ofertas)==null?void 0:k.titulo),className:"h-full w-full object-cover object-center"}):e.jsx("div",{className:"flex items-center justify-center h-full w-full bg-gray-100 dark:bg-gray-700",children:e.jsx(S,{className:"text-gray-400 text-xl"})})}),e.jsxs("div",{className:"ml-6 flex-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("h3",{className:"text-base font-medium text-gray-900 dark:text-white",children:((v=r.productos)==null?void 0:v.nombre)||((w=r.ofertas)==null?void 0:w.titulo)}),e.jsxs("p",{className:"ml-4 text-base font-medium text-gray-900 dark:text-white",children:[r.subtotal.toFixed(2),"€"]})]}),e.jsxs("p",{className:"mt-1 text-sm text-gray-500 dark:text-gray-400",children:["Cantidad: ",r.cantidad," × ",r.precio_unitario.toFixed(2),"€"]}),r.ofertas&&e.jsx("div",{className:"mt-1",children:e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-400",children:"Oferta aplicada"})})]})]},r.id)})}),e.jsxs("div",{className:"p-6 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex justify-between text-base font-medium text-gray-900 dark:text-white",children:[e.jsx("p",{children:"Total"}),e.jsxs("p",{children:[t.total.toFixed(2),"€"]})]}),e.jsx("p",{className:"mt-1 text-sm text-gray-500 dark:text-gray-400",children:"Impuestos incluidos"})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-soft p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-4",children:"¿Necesitas ayuda?"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 mb-4",children:"Si tienes alguna pregunta sobre tu pedido o necesitas ayuda, no dudes en contactar con nuestro equipo de soporte."}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx(x,{to:`/soporte?ref=order&id=${t.id}`,className:"button-modern button-primary",children:"Contactar con soporte"}),e.jsx(x,{to:"/preguntas-frecuentes",className:"button-modern button-secondary",children:"Preguntas frecuentes"})]})]})]})};export{W as default};
