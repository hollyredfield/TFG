import{j as e}from"./ui-BJ93jQot.js";import{a as d}from"./vendor-TA_wDYrC.js";import{u as J,aA as K,V as n,aB as M,aC as T,ai as q,a2 as G,aD as B}from"./index-BlDEwxQf.js";import{V as P}from"./VoteSystem-C-S41ZoI.js";import{f as U,e as X}from"./es-tLztjAZs.js";const te=({productId:u,productType:x,initialComments:j=[]})=>{const{user:o,isAuthenticated:m}=J(),[i,p]=d.useState(j),[b,v]=d.useState(""),[g,N]=d.useState(null),[h,l]=d.useState(!1),[R,w]=d.useState(null),[_,f]=d.useState(""),[C,S]=d.useState(null);d.useEffect(()=>{(async()=>{l(!0);try{const a=`comments_${x}_${u}`,r=localStorage.getItem(a);if(r)p(JSON.parse(r));else if(j.length===0){const s=[{id:"comment-1",user_id:"user-1",user_name:"MaríaGarcía",avatar_url:"https://randomuser.me/api/portraits/women/44.jpg",content:"¡Este producto es fantástico! Lo recomiendo totalmente.",created_at:new Date(Date.now()-864e5).toISOString(),votes:5,parent_id:null},{id:"comment-2",user_id:"user-2",user_name:"CarlosRodriguez",avatar_url:"https://randomuser.me/api/portraits/men/32.jpg",content:"La calidad es buena pero el envío tardó demasiado.",created_at:new Date(Date.now()-1728e5).toISOString(),votes:2,parent_id:null},{id:"comment-3",user_id:"user-3",user_name:"LauraLopez",avatar_url:"https://randomuser.me/api/portraits/women/68.jpg",content:"¿Alguien sabe si hay tallas más grandes disponibles?",created_at:new Date(Date.now()-6048e5).toISOString(),votes:0,parent_id:null},{id:"comment-4",user_id:"user-1",user_name:"MaríaGarcía",avatar_url:"https://randomuser.me/api/portraits/women/44.jpg",content:"Yo compré la talla XL y me quedó bien.",created_at:new Date(Date.now()-5184e5).toISOString(),votes:1,parent_id:"comment-3"}];p(s),localStorage.setItem(a,JSON.stringify(s))}}catch(a){console.error("Error fetching comments:",a),n.error("No se pudieron cargar los comentarios")}finally{l(!1)}})()},[u,x,j]);const E=async t=>{if(t.preventDefault(),!m){n.error("Debes iniciar sesión para comentar");return}if(!b.trim()){n.error("El comentario no puede estar vacío");return}l(!0);try{const r={id:`comment-${Date.now()}`,user_id:o.id,user_name:o.nombre_usuario||o.email,avatar_url:o.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(o.nombre_usuario||o.email)}&background=random`,content:b,created_at:new Date().toISOString(),votes:0,parent_id:g},s=`comments_${x}_${u}`,c=[...i,r];localStorage.setItem(s,JSON.stringify(c)),p(c),v(""),N(null),n.success("Comentario publicado con éxito")}catch(a){console.error("Error posting comment:",a),n.error("Error al publicar el comentario")}finally{l(!1)}},z=async t=>{if(!_.trim()){n.error("El comentario no puede estar vacío");return}l(!0);try{const a=`comments_${x}_${u}`,r=i.map(s=>s.id===t?{...s,content:_}:s);localStorage.setItem(a,JSON.stringify(r)),p(r),w(null),f(""),n.success("Comentario actualizado con éxito")}catch(a){console.error("Error editing comment:",a),n.error("Error al editar el comentario")}finally{l(!1)}},L=async t=>{if(window.confirm("¿Estás seguro de que quieres eliminar este comentario?")){l(!0);try{const a=`comments_${x}_${u}`,r=(y,I)=>{const $=[I];return y.forEach(O=>{O.parent_id===I&&$.push(...r(y,O.id))}),$},s=r(i,t),c=i.filter(y=>!s.includes(y.id));localStorage.setItem(a,JSON.stringify(c)),p(c),n.success("Comentario eliminado con éxito")}catch(a){console.error("Error deleting comment:",a),n.error("Error al eliminar el comentario")}finally{l(!1)}}},F=t=>{w(t.id),f(t.content),S(null)},V=()=>{w(null),f("")},A=t=>U(new Date(t),{addSuffix:!0,locale:X}),D=(()=>{const t=i.filter(r=>!r.parent_id),a=i.filter(r=>r.parent_id);return t.sort((r,s)=>new Date(s.created_at)-new Date(r.created_at)),t.map(r=>({...r,replies:a.filter(s=>s.parent_id===r.id).sort((s,c)=>new Date(s.created_at)-new Date(c.created_at))}))})(),k=(t,a=!1)=>e.jsxs("div",{className:`mb-4 ${a?"ml-12 border-l-2 border-gray-100 pl-4":""}`,children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm p-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("img",{src:t.avatar_url,alt:t.user_name,className:"w-10 h-10 rounded-full mr-3 object-cover"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-800",children:t.user_name}),e.jsxs("p",{className:"text-xs text-gray-500 flex items-center",children:[e.jsx(M,{className:"mr-1"})," ",A(t.created_at)]})]}),m&&(o.id===t.user_id||o.role==="admin")&&e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>S(C===t.id?null:t.id),className:"text-gray-400 hover:text-gray-600",children:e.jsx(T,{})}),C===t.id&&e.jsx("div",{className:"absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10",children:e.jsxs("div",{className:"py-1",children:[e.jsxs("button",{onClick:()=>F(t),className:"block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100",children:[e.jsx(q,{className:"inline mr-2"})," Editar"]}),e.jsxs("button",{onClick:()=>L(t.id),className:"block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100",children:[e.jsx(G,{className:"inline mr-2"})," Eliminar"]})]})})]})]}),R===t.id?e.jsxs("div",{children:[e.jsx("textarea",{value:_,onChange:r=>f(r.target.value),className:"w-full border border-gray-300 rounded-md p-2 mb-2",rows:"3"}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx("button",{onClick:V,className:"px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-100",children:"Cancelar"}),e.jsx("button",{onClick:()=>z(t.id),className:"px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700",disabled:h,children:"Guardar"})]})]}):e.jsx("p",{className:"text-gray-800",children:t.content}),e.jsxs("div",{className:"mt-3 flex justify-between items-center",children:[e.jsx(P,{itemId:t.id,itemType:"comment",initialVotes:t.votes||0}),!a&&e.jsxs("button",{onClick:()=>N(g===t.id?null:t.id),className:`text-sm flex items-center ${g===t.id?"text-blue-600":"text-gray-600 hover:text-blue-600"}`,children:[e.jsx(B,{className:"mr-1"})," Responder"]})]}),g===t.id&&e.jsx("div",{className:"mt-3 border-t border-gray-100 pt-3",children:e.jsxs("form",{onSubmit:E,className:"flex flex-col",children:[e.jsx("textarea",{value:b,onChange:r=>v(r.target.value),placeholder:"Escribe tu respuesta...",className:"w-full border border-gray-300 rounded-md p-2 mb-2",rows:"2"}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx("button",{type:"button",onClick:()=>N(null),className:"px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-100",children:"Cancelar"}),e.jsx("button",{type:"submit",className:"px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700",disabled:h,children:"Responder"})]})]})})]})]})}),t.replies&&t.replies.map(r=>k(r,!0))]},t.id);return e.jsxs("div",{className:"mt-8 bg-gray-50 rounded-lg p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[e.jsx(K,{className:"mr-2 text-primary"}),"Comentarios (",i.length,")"]}),g===null&&e.jsx("div",{className:"mb-6",children:e.jsxs("form",{onSubmit:E,className:"bg-white rounded-lg shadow-sm p-4",children:[e.jsx("textarea",{value:b,onChange:t=>v(t.target.value),placeholder:m?"Escribe tu comentario...":"Inicia sesión para comentar",className:"w-full border border-gray-300 rounded-md p-3 mb-3",rows:"3",disabled:!m}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:"text-sm text-gray-500",children:!m&&"Debes iniciar sesión para comentar"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark disabled:opacity-50",disabled:!m||h,children:h?"Enviando...":"Publicar comentario"})]})]})}),e.jsx("div",{children:h&&i.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-blue-500 rounded-full border-t-transparent mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-500",children:"Cargando comentarios..."})]}):D.length>0?D.map(t=>k(t)):e.jsx("div",{className:"text-center py-8 bg-white rounded-lg",children:e.jsx("p",{className:"text-gray-500",children:"No hay comentarios todavía. ¡Sé el primero en comentar!"})})})]})};export{te as C};
