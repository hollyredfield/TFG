import{j as e}from"./ui-BJ93jQot.js";import{a as c,L as S}from"./vendor-TA_wDYrC.js";import{u as O,ah as _,l as D,a1 as A,d as C,O as N,V as f}from"./index-BlDEwxQf.js";import{m as F}from"./mockData-0ElwO_P3.js";import{O as L}from"./OfferCard-COSGjkOA.js";import"./openrouter-DmZqj64n.js";const T=({currentOfferId:h,categoryId:d,storeId:m,limit:l=4,title:y="También te podría interesar"})=>{const{user:r}=O(),[n,b]=c.useState([]),[v,p]=c.useState(!0),[u,g]=c.useState(null),[t,x]=c.useState(!0);c.useEffect(()=>{(async()=>{if(p(!0),g(null),r)try{try{const{data:s}=await N.from("notificaciones_preferencias").select("recommendation_notifications").eq("user_id",r.id).single();s&&x(s.recommendation_notifications!==!1)}catch(s){console.warn("Could not load notification preferences, defaulting to enabled:",s.message)}}catch(s){console.error("Error fetching API-based recommendations:",s),g("Error al cargar recomendaciones personalizadas. Mostrando sugerencias generales.")}let o=F.ofertas.filter(s=>s.id!==h);const j=o.filter(s=>d&&s.categoriaId===d||m&&s.tiendaId===m);let i=[];if(j.length>0&&(i=[...j]),i.length<l){const k=o.filter(E=>!i.some(R=>R.id===E.id)).sort(()=>.5-Math.random());i.push(...k.slice(0,l-i.length))}b(i.sort(()=>.5-Math.random()).slice(0,l)),p(!1)})()},[r,h,d,m,l]);const w=async()=>{if(!r){f.error("Debes iniciar sesión para configurar notificaciones");return}try{const a=!t;x(a);const{error:o}=await N.from("notificaciones_preferencias").upsert({user_id:r.id,recommendation_notifications:a,updated_at:new Date().toISOString()});if(o)throw o;f.success(a?"Notificaciones de recomendaciones activadas":"Notificaciones de recomendaciones desactivadas")}catch(a){console.error("Error toggling notifications:",a),f.error("No se pudieron actualizar las preferencias"),x(!t)}};return v?e.jsx("section",{className:"py-10",children:e.jsx("div",{className:"container mx-auto px-4",children:e.jsx("div",{className:"flex justify-center my-12",children:e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-primary rounded-full border-t-transparent"})})})}):u&&n.length===0?e.jsx("section",{className:"py-10",children:e.jsx("div",{className:"container mx-auto px-4",children:e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-300 p-4 rounded-lg",children:[u," (Y no se encontraron recomendaciones de muestra)"]})})}):!r&&n.length===0?null:n.length===0?e.jsx("section",{className:"py-10",children:e.jsxs("div",{className:"container mx-auto px-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-6",children:y}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-center py-8",children:"No hay recomendaciones disponibles en este momento."})]})}):e.jsx("section",{className:"py-10",children:e.jsxs("div",{className:"container mx-auto px-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(_,{className:"text-yellow-500 text-2xl mr-3"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Recomendaciones para ti"})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("button",{onClick:w,className:`flex items-center space-x-2 text-sm ${t?"text-primary":"text-gray-500 dark:text-gray-400"}`,"aria-label":t?"Desactivar notificaciones":"Activar notificaciones",title:t?"Desactivar notificaciones":"Activar notificaciones",children:[t?e.jsx(D,{}):e.jsx(A,{}),e.jsx("span",{className:"hidden sm:inline",children:t?"Notificar":"Sin notificar"})]}),e.jsxs(S,{to:"/recomendaciones",className:"text-primary flex items-center text-sm font-medium hover:underline",children:[e.jsx("span",{children:"Ver más"}),e.jsx(C,{className:"ml-1"})]})]})]}),n.length===0?e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-center py-8",children:"No hay recomendaciones disponibles en este momento"}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:n.slice(0,4).map(a=>e.jsx(L,{offer:a},a.id))})]})})};export{T as R};
